name: PullRequestReviewResult

on:
  pull_request_review:
    types:
      - submitted
jobs:
  update-issue-on-request-changes:
    runs-on: ubuntu-latest
    # レビューのタイプが 'approved'、'changes_requested' の場合にのみ実行
    if: ${{ github.event.review.state == 'approved' || github.event.review.state == 'changes_requested' }}
    steps:
      - name: Extract Issue number from PR body
        id: get_issue_number
        run: |
          # PR本文から #123 の形式のIssue番号を抽出する（正規表現は適宜調整してください）
          PR_BODY="${{ github.event.pull_request.body }}"
          ISSUE_NUMBER=$(echo "$PR_BODY" | grep -oE '#[0-9]+' | head -n 1 | tr -d '#')
          if [ -n "$ISSUE_NUMBER" ]; then
            echo "issue_number=$ISSUE_NUMBER" >> $GITHUB_OUTPUT
            echo "Found Issue Number: $ISSUE_NUMBER"
          else
            echo "::error::No Issue NUMBER found in PR body. Please link an issue (e.g., #123)."
            exit 1
          fi

      - name: Update Project Custom Field
        id: get_status
        run: |
          if ${{ github.event.review.state == 'approved' }}; then
            ISSUE_STATUS="レビュー承認"
          elif ${{ github.event.review.state == 'changes_requested' }}; then
            ISSUE_STATUS="レビュー否認"
          else
            ISSUE_STATUS="レビュー依頼"
          fi
          if [ -n "$ISSUE_STATUS" ]; then
            echo "issue_status=$ISSUE_STATUS" >> $GITHUB_OUTPUT
            echo "Found Issue STATUS: $ISSUE_STATUS"
          else
            echo "::error::No Issue STATUS found in Review State. Please check state."
            exit 1
          fi

      - name: changes status to the linked Issue
        if: steps.get_issue_number.outputs.issue_number != '' && steps.get_status.outputs.issue_status != ''
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          # 環境変数で必要な情報を定義
          ORG: ${{ github.repository_owner }} # 組織名 (組織プロジェクトの場合)
          PROJECT_NUMBER: 3 # プロジェクト番号
          FIELD_NAME: "Status" # 更新したいカスタムフィールド名
          NEW_VALUE: steps.get_status.outputs.issue_status # 設定したい値
        run: |
          gh project item-edit $PROJECT_NUMBER --owner $ORG --field-name $FIELD_NAME --value steps.get_status.outputs.issue_status --issue steps.get_issue_number.outputs.issue_number
