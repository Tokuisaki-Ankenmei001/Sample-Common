name: PullRequestReviewResult

on:
  pull_request_review:
    types:
      - submitted
permissions:
  contents: write # リポジトリの書き込み権限を付与
  issues: write
jobs:
  update-issue-on-request-changes:
    runs-on: ubuntu-latest
    # レビューのタイプが 'approved'、'changes_requested' の場合にのみ実行
    if: ${{ github.event.review.state == 'approved' || github.event.review.state == 'changes_requested' }}
    permissions:
      contents: read
      issues: read
      pull-requests: read
    steps:
      - name: Extract Issue number from PR body
        id: get_issue_number
        run: |
          # PR本文から #123 の形式のIssue番号を抽出する（正規表現は適宜調整してください）
          PR_BODY="${{ github.event.pull_request.body }}"
          ISSUE_NUMBER=$(echo "$PR_BODY" | grep -oE '#[0-9]+' | head -n 1 | tr -d '#')
          if [ -n "$ISSUE_NUMBER" ]; then
            echo "issue_number=$ISSUE_NUMBER" >> $GITHUB_OUTPUT
            echo "Found Issue ID: $ISSUE_NUMBER"
          else
            echo "::error::No Issue NUMBER found in PR body. Please link an issue (e.g., #123)."
            exit 1
          fi

      - name: Set Project Custom Field
        id: get_status
        run: |
          if ${{ github.event.review.state == 'approved' }}; then
            ISSUE_STATUS="レビュー承認"
          elif ${{ github.event.review.state == 'changes_requested' }}; then
            ISSUE_STATUS="レビュー否認"
          else
            ISSUE_STATUS="レビュー依頼"
          fi
          if [ -n "$ISSUE_STATUS" ]; then
            echo "issue_status=$ISSUE_STATUS" >> $GITHUB_OUTPUT
            echo "Found Issue STATUS: $ISSUE_STATUS"
          else
            echo "::error::No Issue STATUS found in Review State. Please check state."
            exit 1
          fi

      - name: Update associated Issue Status in GitHub Project
        if: steps.get_issue_number.outputs.issue_number != '' && steps.get_status.outputs.issue_status != ''
        env:
          # Projectsへの書き込み権限を持つPATをSecretsに登録し、ここで使用
          GH_TOKEN: ${{ secrets.MY_PAT }}
          ISSUE_NUMBER: ${{ steps.get_issue_number.outputs.issue_number }}
          ORG_NAME: ${{ github.repository_owner }}                         # Organization名 (User Projectsの場合はユーザー名)
          PROJECT_NUMBER: 3                                                # Projectsの番号 (URL末尾の番号)
          FIELD_NAME: Status                                               # 更新したいカスタムフィールド名
          NEW_STATUS_VALUE: ${{ steps.get_status.outputs.issue_status }}   # 設定したい新しい値
        run: |
          # 1. ProjectsのNode IDを取得
          PROJECT_ID=$(gh api graphql -f query='
            query {
              organization(login: "${{ env.ORG_NAME }}") {
                projectV2(number: ${{ env.PROJECT_NUMBER }}) {
                  id
                }
              }
            }
          ' --jq '.data.organization.projectV2.id')
          # User Projectsの場合はorganizationをuserに変更

          # 2. カスタムフィールドのIDとオプションIDを取得
          FIELD_DATA=$(gh api graphql -f query='
            query($projectId: ID!) {
              node(id: $projectId) {
                ... on ProjectV2 {
                  field(name: "${{ env.FIELD_NAME }}") {
                    ... on ProjectV2SingleSelectField {
                      id
                      options {
                        id
                        name
                      }
                    }
                  }
                }
              }
            }
          ' -v projectId=$PROJECT_ID --jq '.data.node.field')

          FIELD_ID=$(echo "$FIELD_DATA" | jq -r '.id')
          OPTION_ID=$(echo "$FIELD_DATA" | jq -r --argjson val "${{ toJson(env.NEW_STATUS_VALUE) }}" '.options[] | select(.name == $val) | .id')

          # 3. IssueのNode IDを取得
          ISSUE_ID=$(gh api graphql -f query='
            query {
              repository(owner: "${{ env.ORG_NAME }}", name: "${{ github.event.repository.name }}") {
                issue(number: ${{ env.ISSUE_NUMBER }}) {
                  id
                }
              }
            }
          ' --jq '.data.repository.issue.id')

          # 4. Projectsアイテムのフィールド値を更新
          gh api graphql -f query='
            mutation($projectId: ID!, $itemId: ID!, $fieldId: ID!, $value: ProjectV2SingleSelectFieldOptionValueInput!) {
              updateProjectV2ItemFieldValue(input: {
                projectId: $projectId,
                itemId: $itemId,
                fieldId: $fieldId,
                value: $value
              }) {
                projectV2Item {
                  id
                }
              }
            }
          ' -v projectId=$PROJECT_ID -v itemId=$ISSUE_ID -f fieldId=$FIELD_ID -f value='{"singleSelectOptionId": "'"$OPTION_ID"'"}'
